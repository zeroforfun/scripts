### ip

ip 地址分为 ipv4 和 ipv6

由于 ipv6 现实仍然难以使用或不如 ipv4 普及此处不予讨论, 下称 ip 地址均为 ipv4 地址

#### 格式

ipv4 地址格式 如 127.0.0.1 192.168.1.1 192.168.43.1 10.0.0.1 169.254.0.1 8.8.8.8

由 4 个 0-255 的数字和三个把它隔开的点组成, 因此转换为二进制占 4 个字节 即 32 个比特位

所有 255 为结尾的地址经常使用作为广播地址不应做他用, 静态网关 ip 经常使用 1 或 254 为结尾的 ip 地址

##### A 类地址 32 位二进制以 0 开头的地址 即 0.0.0.0 - 127.255.255.255 (0.0.0.0/1)

其中 0.0.0.0 - 0.255.255.255.255 (0.0.0.0/8) 除 0.0.0.0 外为不应使用的非法地址 0.0.0.0 为当前主机

其中 127.0.0.0 - 127.255.255.255 (127.0.0.0/8) 用于本地回环网卡 公网不应使用

其中 10.0.0.0 - 10.255.255.255 (10.0.0.0/8) 为私有地址 用于局域网 公网不应使用

##### B 类地址 32 位二进制以 10 开头的地址 即 128.0.0.0 - 191.255.255.255 (128.0.0.0/2)

其中 172.16.0.0 - 172.31.255.255 (172.16.0.0/12) 为私有地址 用于局域网 公网不应使用

其中 169.254.0.0 -169.254.255.255 (169.254.0.0/16) 为保留地址 为网络故障如网卡没有获得 ip 地址时被系统配置其中的地址 公网不应使用

##### C 类地址 32 位二进制以 110 开头的地址 即 192.0.0.0 - 223.255.255.255 (192.0.0.0/3)

其中 192.168.0.0 - 192.168.255.255 (192.168.0.0/16) 为私有地址 用于局域网 公网不应使用

##### D 类地址 32 位二进制以 1110 开头的地址 即 224.0.0.0 - 239.255.255.255 (224.0.0.0/4) 不适用网段概念 此处仅方便表达

其中 224.0.0.0 - 224.0.0.255 (224.0.0.0/24) 为预留的组播地址(永久组地址) 224.0.0.0 保留不做分配 其他地址供路由协议使用

其中 224.0.1.0 - 238.255.255.255 为用户可用的组播地址(临时组地址) 全网范围内有效

其中 239.0.0.0 - 239.255.255.255 (239.0.0.0/8) 为本地管理组播地址 仅在特定的本地范围内有效

均为多播地址 初学者不必理会 不应使用

##### E 类地址 32 位二进制以 11110 开头的地址 即 240.0.0.0 - 255.255.255.255 (240.0.0.0/5) 不适用网段概念 此处仅方便表达

其中 255.255.255.255 为以太网协议的广播地址 经常用于分配 ip 地址前和过程中的通信

其中 240.0.0.0 - 254.255.255.255 为保留地址 用作实验研究

其余为非法地址不应使用

#### 子网掩码和网段

ip 地址用于通信, 协议将 ip 地址划分不同网段

子网掩码拥有 ip 地址的形式, 整个 ip 网段中相同位将该网段相应位置为 1 整个 ip 网段中可变的位将该网段相应位置为 0

例如 192.168.1.0 -192.168.1.255 可被划分为一个网段 子网掩码为 255.255.255.0

因 192.168.1.0 - 192.168.1.255 前 16 均相同 后 8 为可变

192.168.1.0 255.255.255.0 可表达 192.168.1.0 - 192.168.1.255 的网段 简化写作 192.168.1.0/24

赋予一个网卡一个 ip 地址时需要提供网段信息, 以告知系统只处理网段内的数据, 不处理网段外的数据

例如赋予一张网卡 192.168.1.1/24 的地址意味着, 网卡应处理 192.168.1.0 - 192.168.1.255 向 192.168.1.1 发送的数据, 并将数据发送到 192.168.1.0 -192.168.1.255

但 ip 报文中没有子网掩码的字段, 意味着子网掩码只是本系统处理数据的规则, 不涉及通信对方处理数据的规则

即一根网线两端的网卡地址若分别为 192.168.1.1/24 192.168.1.2/25, 他们仍可正常通信

### interface

网卡 网卡之间需要网线连接, 网卡把网线中的数据交给系统处理, 把系统的数据写入网线

linux 一张网卡可以由多个 ip 地址

因为以太网协议需要一个以太网广播域中每个网卡有不同的 mac 地址

每张物理网卡都有全球唯一的物理 mac 地址, 可根据 mac 地址寻找网卡生产商

mac 地址的格式是 6 个 16 进制的 00 - ff 的数字由 5 个 : 隔开 例如 52:54:00:00:00:00

操作系统会从网卡中读取 mac 地址放入以太网协议中进行通信

因此可更改操作系统填入以太网协议中的 mac 地址, 防止泄漏隐私, mac 常被用来追踪以及付费软件的认证 (如 matlab)

相关命令为 ip link set eth0 address 52:54:00:00:00:00

一些设备和系统支持随机 mac 地址, 但一些操作系统并不总是支持

### hub/bridge

交换机/网桥

一个网段中多个 ip 地址分别绑定在不同网卡上想要高效相互通信需要交换机/网桥

交换机上有多个网卡分别与需要互相通信的多个网卡相连 转发报文

交换机识别各个网卡对方的 mac 地址 在以太网层次上工作, 根据报文中的目标 mac 地址发送到相应的网卡上

以太网请求报文除非在寻找一个 ip 地址的广播阶段或多播功能, 应至少有来源 mac 地址和目的 mac 地址, 请求报文和回复报文应相互对调使得回复报文原路返回

交换机上的网卡仅有转发功能即使有 mac 地址也不会出现在以太网报文中

若通过一根网线将两个交换机连接在一起, 则形成一个以太网的广播域, 以此类推, 相隔多个交换机的网卡也可以通过以太网协议进行通信

linux 支持 bridge 的网络设备, 角色与交换机类似, 由内核负责转发报文, 可将其他网卡的 master 设为一个 bridge, 类似于将该网卡网线另一端的网卡连接到交换机

相关命令为 ip link add name bridge0 type bridge 启动命令为 ip link set dev bridge0 up

关闭命令为 ip link set dev bridge0 down 删除命令为 ip link delete dev bridge0 type bridge

举例而言 一张物理网卡可视为两端, 一端通过网线连接外部读写数据, 另一端从系统中读写数据

若将一张物理网卡 master 设为一个网桥, 则网卡一端通过网线连接外部读写数据, 另一端只从网桥中读写数据, 该网卡和 bridge 共同可视为一个交换机, 该网卡为交换机的一个网口

此时物理网卡即使绑定 ip 地址也不再能与外界进行 ip 层次上的通信, 只能进行以太网层次上的通信, 把 ip 地址从物理网卡上删除添加到网桥后可与外界进行 ip 层次上的通信

### route

路由器 由于此概念被泛化, 易于混淆, 这里默认的 route 非指软件概念, 仅指有两个网卡转发两个网段的硬件路由器, 不包括可同时连接多个网卡的大部分家用 wifi 路由器(相关原理见下文)

由网桥的概念可知, 网桥可供同一网段的不同网卡相互通信

不同网段的通信应使用 route

route 的两个网卡应分别与不同网段上的网卡连接, 两个网卡应分别在两个网段上拥有一个 ip 地址

两个网段中希望与另一网段通信的设备均应把对方网段的路由指向路由器在自身网段的地址作为网关

route 工作在 ip 层次上, 根据报文中的来源 ip 和 目的 ip 决定转发行为

除非在分配 ip 而进行的广播阶段, 通常 ip 报文中应至少有来源 ip 和目的 ip, 请求报文和回复报文应相互对调使得回复报文原路返回

需要通过 route 转发的报文应被发送到 route 上同网段网卡的 mac 地址, 来源 ip 为请求设备的 ip, 目的 ip 即为另一网段

一个相关实践的脚本为 https://github.com/zeroforfun/scripts/blob/main/ip/route.sh

route 收到目的 mac 地址为自身设备 A 的 mac 地址的以太网报文, 读取其中的 ip 报文, 查看来源 ip 和 目的 ip 后发现, 目的 ip 处在 B 网卡的所处网段上, 将以太网报文中的来源 mac 地址修改 B 网卡的 mac 地址, 目的 mac 地址修改为目的 ip 对应的 mac 地址 (若不存在缓存, 通过以太网广播寻找), route 不修改 ip 报文, 目的 ip 收到报文后若目的 ip 的设备中路由表配置正确则回复报文可视为另一次针对来源 ip 的请求, 行为对称不赘述

route 可层层嵌套, 例如 10.0.0.0/24 和 10.0.1.0/24 可相互访问, 10.1.0.0/24 和 10.1.1.0/24 可互相访问, 将 10.0.0.254/8 和 10.1.0.254/8 连接在同一路由器的两端, 10.0.0.0/24 将 10.1.0.0/16 在路由表指向 10.0.0.254, 10.0.1.0/24 将 10.1.0.0/16 在路由表指向 10.0.1.1, 10.1.0.0/24 将 10.0.0.0/16 路由表指向 10.1.0.254, 10.1.1.0/24 将 10.0.0.0/16 路由表指向 10.1.1.1,  10.0.0.0/16 的路由器将 10.1.0.0/16 在路由表指向 10.0.0.254, 10.1.0.0/16 的路由器将 10.0.0.0/16 在路由表指向 10.1.0.254, 则设备均可相互访问 相关实践的脚本为 https://github.com/zeroforfun/scripts/blob/main/ip/nested.sh

#### 举例而言

route 与网段 10.0.0.0/24 相连网卡的地址为 10.0.0.1 与网段 10.0.1.0/24 相连网卡的地址为 10.0.1.1

10.0.0.0/24 中的一台设备例如 10.0.0.2 应把 10.0.0.1 设为通向网段 10.0.1.0/24 的网关 相关命令为 ip route add 10.0.1.0/24 via 10.0.0.1 (配置路由表)

10.0.1.0/24 中的一台设备例如 10.0.1.2 应把 10.0.1.1 设为通向网段 10.0.0.0/24 的网关 相关命令为 ip route add 10.0.0.0/24 via 10.0.1.1 (配置路由表)

路由器若为 linux 系统应启用转发功能 相关命令为 echo 1 > /proc/sys/net/ipv4/ip_forward (或 sysctl -w net.ipv4.ip_forward=1)

从 10.0.0.2 ping 10.0.1.1 10.0.1.2 应均可成功

从 10.0.1.2 ping 10.0.0.1 10.0.0.2 应均可成功

错误 1: 只在一个网段上正确配置了路由表

假设 10.0.0.2 上路由正确配置 10.0.1.2 上没有相应配置路由表

10.0.0.2 ping 10.0.1.1 应成功 10.0.1.2 应不成功

10.0.1.2 ping 10.0.0.1 10.0.0.2 均应不成功

因为 10.0.0.2 ping 10.0.1.2 发送的报文可达到 但回复报文无法正确返回

(10.0.0.2 ping 10.0.1.1 应成功的原因查看后续关于 network space 的说明)

错误 2: 路由器若为 linux 系统且没有启用转发功能 

从 10.0.0.2 ping 10.0.1.1 应成功 10.0.1.2 应不成功 (前者应成功的原因查看后续关于 network space 的说明)

从 10.0.1.2 ping 10.0.0.1 应成功 10.0.0.2 应不成功 (前者应成功的原因查看后续关于 network space 的说明)

初学者常把两者混淆

route 路由器在两个网段均有地址, 两个网段均应把对方网段的路由指向路由器在自身网段的地址作为网关, 路由器通过转发使得双方相互通信, 修改以太网报文, 不修改 ip 报文

nat 是地址转换, 路由接收到请求后修改报文中的源地址 目的地址等字段, 通常目的是使用其他地址进行通信, 对于通信双方可能不知道对方的地址

#### 因此

route 不修改 ip 报文, 连接的两个网段地位是相同的, 两个网段可相互通信, 一旦进行通信通信双方相互可知对方的存在和地址

route 被用来搭建公网, 在公网细分的不同网段上转发转发报文

公网的拓扑结构非常复杂, 由网络运营商根据分配得到的 ip 网段和地址搭建与相应 ip 网段和地址通信使用的拓扑结构, 不同公司网络仍要互相连接进行通信构建国际互联网

route 也可用来搭建复杂的局域网, 因此不与公网通信的局域网可使用公网 ip

#### 路由表

此处涉及 route 软件相关的概念

命令 ip route 可查看 linux 系统当前路由表

例如上述 10.0.0.2 的设备的路由表应类似

10.0.1.0/24 via 10.0.0.1 dev eth0

10.0.0.0/24 dev eth0 proto kernel scope link src 10.0.0.2

第一行为指向 10.0.1.0/24 的路由

在构建目的 ip 为处于 10.0.1.0/24 网段的以太网报文时, 目的 mac 地址应为 ip 为 10.0.0.1 对应的 mac 地址, 报文通过 eth0 设备发送出去

第二行为指向 10.0.0.0/24 网卡所在网段的网段, 一旦向网卡添加一个网段的 ip 地址, 该网段的路由由内核自动添加, 于是有 proto kernel 的输出

### nat

为了为私有地址发起向公网的通信, 采用了 nat 的方法, 即 Network Address Translators 网络地址转换

例如一个典型使用 nat 上网设备的路由表

default via 192.168.1.1 dev wlan0

192.168.1.0/24 dev wlan0 proto kernel scope link src 192.168.1.2


